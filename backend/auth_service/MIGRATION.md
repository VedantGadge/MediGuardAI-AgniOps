# Migration Guide: Node.js to FastAPI Authentication

## Overview

This guide helps you migrate from the Node.js authentication service to the FastAPI authentication service while maintaining full compatibility with your existing system.

## What's Changed

### Technology Stack
- **Before**: Express.js (Node.js)
- **After**: FastAPI (Python)

### What Stays the Same
- ‚úÖ MongoDB database (same connection, same collections)
- ‚úÖ User schema and data structure
- ‚úÖ JWT token format and validation
- ‚úÖ Password hashing (bcrypt)
- ‚úÖ API endpoints (`/api/auth/signup`, `/api/auth/login`)
- ‚úÖ Request/response format
- ‚úÖ Authentication flow

## Step-by-Step Migration

### 1. Setup FastAPI Service

```powershell
# Navigate to auth_service directory
cd backend/auth_service

# Run the startup script (it will create venv and install dependencies)
.\start.ps1
```

Or manually:

```powershell
# Create virtual environment
python -m venv venv

# Activate virtual environment
.\venv\Scripts\Activate.ps1

# Install dependencies
pip install -r requirements.txt

# Copy environment file
copy .env.example .env
```

### 2. Configure Environment Variables

Edit `backend/auth_service/.env` and ensure it matches your Node.js configuration:

```env
# CRITICAL: Use the SAME values from your Node.js .env file
MONGODB_URI=mongodb://localhost:27017/mediguard  # Same as Node.js
DB_NAME=mediguard                                 # Same database name
JWT_SECRET=your-super-secret-jwt-key              # MUST be the same!
JWT_EXPIRE=30d                                    # Same expiration time
```

**Important**: The `JWT_SECRET` must be identical to your Node.js backend for token compatibility!

### 3. Test the FastAPI Service

Start the FastAPI service:

```powershell
cd backend/auth_service
python main.py
```

The service will run on `http://localhost:8001`

Test the endpoints:

```powershell
# Health check
curl http://localhost:8001/api/health

# View API documentation
# Open browser: http://localhost:8001/docs
```

### 4. Update Frontend Configuration

#### Option A: Complete Migration (Recommended)

Update your frontend API base URL to point to FastAPI:

```javascript
// Before
const API_BASE_URL = 'http://localhost:5000';

// After
const API_BASE_URL = 'http://localhost:8001';
```

#### Option B: Gradual Migration (Run Both Services)

Run both services on different ports and use a proxy or update specific endpoints:

```javascript
// Keep Node.js for other endpoints
const API_BASE_URL = 'http://localhost:5000';

// Use FastAPI only for auth
const AUTH_API_URL = 'http://localhost:8001';

// Auth requests
axios.post(`${AUTH_API_URL}/api/auth/signup`, data);
axios.post(`${AUTH_API_URL}/api/auth/login`, data);

// Other requests
axios.get(`${API_BASE_URL}/api/other-endpoint`);
```

### 5. Verify Token Compatibility

Test that tokens generated by FastAPI work with your existing system:

1. **Login using FastAPI** and get a token
2. **Use that token** to access protected routes in your Node.js backend
3. **Verify** that authentication works correctly

If tokens don't work, double-check that `JWT_SECRET` is identical in both services.

### 6. Run Both Services Simultaneously (Testing Phase)

During testing, you can run both services:

**Terminal 1 - Node.js (Port 5000):**
```powershell
cd backend
npm start
```

**Terminal 2 - FastAPI (Port 8001):**
```powershell
cd backend/auth_service
python main.py
```

### 7. Update Node.js Server (Optional)

If you want to completely replace the Node.js auth routes, update `server.js`:

```javascript
// Comment out or remove this line:
// app.use('/api/auth', require('./routes/auth'));

// Add a proxy to FastAPI for auth requests (optional)
const { createProxyMiddleware } = require('http-proxy-middleware');

app.use('/api/auth', createProxyMiddleware({
  target: 'http://localhost:8001',
  changeOrigin: true,
}));
```

## Testing Checklist

- [ ] FastAPI service starts without errors
- [ ] MongoDB connection successful
- [ ] User signup creates records in database
- [ ] User login returns valid JWT token
- [ ] Tokens work with existing Node.js protected routes
- [ ] Password validation works correctly
- [ ] Email validation works correctly
- [ ] Error messages are appropriate
- [ ] Frontend can communicate with FastAPI service
- [ ] CORS is properly configured

## Performance Comparison

After migration, you should notice:
- ‚úÖ Faster response times (async/await)
- ‚úÖ Better concurrent request handling
- ‚úÖ Lower memory usage
- ‚úÖ Automatic API documentation (Swagger UI)

## Rollback Plan

If you need to rollback to Node.js:

1. Stop the FastAPI service
2. Revert frontend API URL changes
3. Restart Node.js service
4. All data remains intact in MongoDB

## Common Issues and Solutions

### Issue: JWT tokens not working between services

**Solution**: Ensure `JWT_SECRET` is EXACTLY the same in both `.env` files.

### Issue: MongoDB connection fails

**Solution**: 
- Check `MONGODB_URI` is correct
- Ensure MongoDB is running
- Verify network connectivity

### Issue: CORS errors from frontend

**Solution**: Update `CLIENT_URL` in `.env` to match your frontend URL.

### Issue: Password validation different

**Solution**: Both services use the same validation rules. Check error messages for details.

### Issue: Port already in use

**Solution**: 
```powershell
# Change AUTH_PORT in .env
AUTH_PORT=8002

# Or stop the service using the port
netstat -ano | findstr :8001
taskkill /PID <PID> /F
```

## Monitoring and Logging

### Check FastAPI Service Status

```powershell
# View logs in terminal where service is running
# FastAPI prints requests and errors to console
```

### Check Node.js Service Status

```powershell
# View logs in Node.js terminal
# Check MongoDB for new user records
```

## Production Deployment

For production deployment:

1. **Use environment-specific configurations**:
   ```env
   NODE_ENV=production
   MONGODB_URI=mongodb+srv://your-production-db
   ```

2. **Run with production server**:
   ```bash
   uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
   ```

3. **Use process manager** (e.g., PM2, systemd):
   ```bash
   # Using PM2
   pm2 start "uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4" --name auth-service
   ```

4. **Setup reverse proxy** (Nginx):
   ```nginx
   location /api/auth {
       proxy_pass http://localhost:8001;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
   }
   ```

## Support

If you encounter any issues during migration:

1. Check the FastAPI logs for errors
2. Verify environment variables
3. Test endpoints using Swagger UI (`http://localhost:8001/docs`)
4. Compare request/response formats with Node.js version

## Next Steps

After successful migration:

1. ‚úÖ Monitor performance metrics
2. ‚úÖ Update documentation
3. ‚úÖ Train team on FastAPI
4. ‚úÖ Consider migrating other endpoints
5. ‚úÖ Optimize database queries if needed

## Benefits of This Migration

- üöÄ **Performance**: FastAPI is one of the fastest Python frameworks
- üìù **Auto Documentation**: Swagger UI and ReDoc out of the box
- ‚úÖ **Type Safety**: Pydantic models provide runtime validation
- üîÑ **Async Support**: Native async/await for better concurrency
- üêç **Python Ecosystem**: Access to ML/AI libraries for future features
- üõ†Ô∏è **Developer Experience**: Better error messages and debugging
